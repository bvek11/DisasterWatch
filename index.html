<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DisasterWatch â€” Live Global Incident Map</title>

  <!-- Leaflet Map -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

  <!-- Chart.js for analytics -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow+Condensed:wght@300;400;600;700;900&family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #080c10;
      --surface: #0d1117;
      --surface2: #161b22;
      --border: #21262d;
      --accent: #ff3b3b;
      --accent2: #ff8c00;
      --accent3: #ffd700;
      --text: #e6edf3;
      --muted: #7d8590;
      --green: #39d353;
      --blue: #58a6ff;
      --purple: #9775fa;
      --orange: #ff922b;
      --yellow: #ffd43b;

      --earthquake: #ff4444;
      --flood: #4488ff;
      --fire: #ff8800;
      --storm: #aa44ff;
      --volcano: #ff4400;
      --tsunami: #0099ff;
      --other: #aaaaaa;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Barlow Condensed', sans-serif;
      overflow: hidden;
      height: 100vh;
    }

    .mono { font-family: 'Share Tech Mono', monospace; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LOADING OVERLAY  (from index1)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #loading-overlay {
      position: fixed;
      inset: 0;
      background: var(--bg);
      z-index: 9000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px;
      transition: opacity 0.6s ease;
    }

    #loading-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .loading-logo {
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 42px;
      font-weight: 900;
      letter-spacing: 8px;
      text-transform: uppercase;
      animation: loading-flicker 0.5s ease 0.3s both;
    }

    @keyframes loading-flicker {
      0% { opacity: 0; transform: scale(0.95); }
      60% { opacity: 1; transform: scale(1.02); }
      100% { opacity: 1; transform: scale(1); }
    }

    .loading-bar-wrap {
      width: 240px;
      height: 2px;
      background: var(--border);
      overflow: hidden;
    }

    .loading-bar {
      height: 100%;
      background: var(--accent);
      width: 0%;
      animation: load-progress 1.8s ease forwards;
    }

    @keyframes load-progress {
      0%   { width: 0%; }
      40%  { width: 55%; }
      80%  { width: 82%; }
      100% { width: 100%; }
    }

    .loading-text {
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
      letter-spacing: 3px;
      color: var(--muted);
      text-transform: uppercase;
      animation: fadecycle 1.6s ease infinite;
    }

    @keyframes fadecycle {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       HEADER
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #header {
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 20px;
      background: linear-gradient(180deg, rgba(8,12,16,0.98) 0%, rgba(8,12,16,0.85) 100%);
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(12px);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      width: 28px; height: 28px;
      background: var(--accent);
      clip-path: polygon(50% 0%, 100% 100%, 0% 100%);
      animation: pulse-triangle 2s ease-in-out infinite;
      flex-shrink: 0;
    }

    @keyframes pulse-triangle {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(0.9); }
    }

    .logo h1 {
      font-size: 20px;
      font-weight: 900;
      letter-spacing: 3px;
      text-transform: uppercase;
    }

    .logo span { color: var(--accent); }

    .header-status {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .live-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 11px;
      letter-spacing: 2px;
      color: var(--green);
      text-transform: uppercase;
    }

    .live-dot {
      width: 8px; height: 8px;
      background: var(--green);
      border-radius: 50%;
      animation: blink 1.5s infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; box-shadow: 0 0 6px var(--green); }
      50% { opacity: 0.3; box-shadow: none; }
    }

    .incident-count {
      font-family: 'Share Tech Mono', monospace;
      font-size: 11px;
      color: var(--muted);
      letter-spacing: 1px;
    }

    .incident-count strong {
      color: var(--accent);
      font-size: 16px;
    }

    .last-updated {
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
      color: var(--muted);
      letter-spacing: 1px;
    }

    .btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      padding: 6px 14px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
      letter-spacing: 2px;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
    }

    .btn:hover {
      border-color: var(--blue);
      color: var(--blue);
    }

    .btn-danger {
      border-color: rgba(255,59,59,0.4);
      color: var(--accent);
    }

    .btn-danger:hover {
      border-color: var(--accent);
      background: rgba(255,59,59,0.08);
    }

    .btn.spinning {
      animation: btn-blink 0.7s ease infinite;
      pointer-events: none;
    }

    @keyframes btn-blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.25; }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MAP
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #map {
      position: fixed;
      top: 50px; left: 0; right: 0; bottom: 0;
    }

    .leaflet-tile {
      filter: brightness(0.55) saturate(0.35) hue-rotate(185deg);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SIDEBAR  (from index1 â€” collapsible)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #sidebar {
      position: fixed;
      top: 50px;
      left: 0;
      bottom: 0;
      width: 300px;
      z-index: 500;
      background: rgba(8, 12, 16, 0.95);
      border-right: 1px solid var(--border);
      backdrop-filter: blur(16px);
      display: flex;
      flex-direction: column;
      transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }

    #sidebar.collapsed {
      transform: translateX(-272px);
    }

    .sidebar-toggle {
      position: absolute;
      right: -14px;
      top: 50%;
      transform: translateY(-50%);
      width: 14px;
      height: 52px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-left: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      color: var(--muted);
      transition: background 0.2s;
      z-index: 10;
      user-select: none;
    }

    .sidebar-toggle:hover { background: var(--border); color: var(--text); }

    .sidebar-header {
      padding: 14px 16px 10px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .sidebar-header h2 {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--muted);
      font-family: 'Share Tech Mono', monospace;
    }

    /* â”€â”€ Filters (index1 monospace style) â”€â”€ */
    .filters {
      padding: 10px 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .filter-btn {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 3px 9px;
      border-radius: 2px;
      border: 1px solid transparent;
      font-family: 'Share Tech Mono', monospace;
      font-size: 9px;
      letter-spacing: 1px;
      cursor: pointer;
      text-transform: uppercase;
      transition: all 0.2s;
      background: var(--surface2);
      color: var(--muted);
    }

    .filter-btn:hover { color: var(--text); border-color: var(--border); }

    .filter-btn.active {
      color: var(--text);
      border-color: currentColor;
    }

    .filter-dot {
      width: 7px; height: 7px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    /* â”€â”€ Incident List (index1 style) â”€â”€ */
    #incident-list {
      flex: 1;
      overflow-y: auto;
      padding: 6px 0;
    }

    #incident-list::-webkit-scrollbar { width: 3px; }
    #incident-list::-webkit-scrollbar-track { background: transparent; }
    #incident-list::-webkit-scrollbar-thumb { background: var(--border); }
    #incident-list { scrollbar-width: thin; scrollbar-color: var(--border) transparent; }

    .incident-item {
      padding: 10px 16px;
      border-bottom: 1px solid rgba(33,38,45,0.6);
      cursor: pointer;
      transition: background 0.15s;
      position: relative;
    }

    .incident-item:hover {
      background: rgba(255,59,59,0.05);
    }

    .incident-item.active {
      background: rgba(255,59,59,0.08);
      border-left: 2px solid var(--accent);
    }

    .incident-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
    }

    .incident-type-badge {
      font-size: 9px;
      font-family: 'Share Tech Mono', monospace;
      letter-spacing: 1px;
      text-transform: uppercase;
      padding: 2px 7px;
      border-radius: 2px;
    }

    .incident-sev-label {
      font-size: 9px;
      font-family: 'Share Tech Mono', monospace;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .incident-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      line-height: 1.35;
      margin-bottom: 3px;
    }

    .incident-loc {
      font-size: 11px;
      color: var(--muted);
      font-family: 'Share Tech Mono', monospace;
    }

    .incident-bottom {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 5px;
    }

    .incident-source {
      font-size: 8px;
      font-family: 'Share Tech Mono', monospace;
      letter-spacing: 1px;
      text-transform: uppercase;
      padding: 1px 6px;
      border-radius: 2px;
      opacity: 0.8;
    }

    .incident-time {
      font-size: 10px;
      color: var(--muted);
      font-family: 'Share Tech Mono', monospace;
    }

    /* â”€â”€ Stats Bar (index1 â€” bottom of sidebar) â”€â”€ */
    .stats-bar {
      padding: 10px 16px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .stat {
      text-align: center;
    }

    .stat-num {
      font-size: 20px;
      font-weight: 700;
      font-family: 'Share Tech Mono', monospace;
      line-height: 1;
    }

    .stat-label {
      font-size: 9px;
      color: var(--muted);
      letter-spacing: 1px;
      text-transform: uppercase;
      margin-top: 3px;
      font-family: 'Share Tech Mono', monospace;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CHARTS PANEL
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #charts-panel {
      position: fixed;
      top: 50px; right: 0; bottom: 0;
      width: 440px;
      z-index: 500;
      background: rgba(8, 12, 16, 0.96);
      border-left: 1px solid var(--border);
      backdrop-filter: blur(20px);
      display: flex;
      flex-direction: column;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      overflow-y: auto;
    }

    #charts-panel.open { transform: translateX(0); }

    #charts-panel::-webkit-scrollbar { width: 3px; }
    #charts-panel::-webkit-scrollbar-thumb { background: var(--border); }

    .charts-header {
      padding: 18px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .charts-header h2 {
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      font-family: 'Share Tech Mono', monospace;
    }

    .chart-container {
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }

    .chart-title {
      font-size: 10px;
      font-weight: 700;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 14px;
      letter-spacing: 2px;
      font-family: 'Share Tech Mono', monospace;
    }

    canvas { max-height: 220px; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LEGEND
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #legend {
      position: fixed;
      bottom: 24px; right: 20px;
      z-index: 600;
      background: rgba(8,12,16,0.95);
      border: 1px solid var(--border);
      backdrop-filter: blur(12px);
      padding: 12px 14px;
      min-width: 160px;
      transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    #legend.shifted {
      right: 460px;
    }

    .legend-title {
      font-size: 9px;
      font-family: 'Share Tech Mono', monospace;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 10px;
    }

    .legend-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 7px;
    }

    .legend-circle { border-radius: 50%; flex-shrink: 0; }

    .legend-label {
      font-size: 11px;
      color: var(--muted);
      font-family: 'Share Tech Mono', monospace;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       POPUP
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .leaflet-popup-content-wrapper {
      background: var(--surface) !important;
      border: 1px solid var(--border) !important;
      border-radius: 0 !important;
      box-shadow: 0 0 0 1px rgba(255,59,59,0.25), 0 8px 32px rgba(0,0,0,0.7) !important;
      padding: 0 !important;
      min-width: 290px;
    }

    .leaflet-popup-tip { background: var(--surface) !important; }
    .leaflet-popup-close-button { color: var(--muted) !important; font-size: 16px !important; padding: 8px 10px !important; }

    .popup-inner { padding: 16px 18px 14px; }

    .popup-header {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 10px;
    }

    .popup-icon { font-size: 26px; line-height: 1; flex-shrink: 0; }

    .popup-type {
      font-size: 9px;
      font-family: 'Share Tech Mono', monospace;
      letter-spacing: 2px;
      text-transform: uppercase;
      margin-bottom: 3px;
    }

    .popup-title { font-size: 15px; font-weight: 700; line-height: 1.3; color: var(--text); }
    .popup-divider { height: 1px; background: var(--border); margin: 10px 0; }

    .popup-row {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 7px;
      font-size: 13px;
    }

    .popup-label {
      color: var(--muted);
      font-family: 'Share Tech Mono', monospace;
      font-size: 9px;
      letter-spacing: 1px;
      text-transform: uppercase;
      min-width: 68px;
      padding-top: 1px;
    }

    .popup-value { color: var(--text); font-size: 13px; line-height: 1.4; flex: 1; }

    .popup-link {
      display: block;
      margin-top: 10px;
      padding: 8px 14px;
      background: rgba(255,59,59,0.1);
      border: 1px solid rgba(255,59,59,0.3);
      color: var(--accent);
      text-decoration: none;
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
      letter-spacing: 2px;
      text-transform: uppercase;
      text-align: center;
      transition: all 0.2s;
    }

    .popup-link:hover {
      background: rgba(255,59,59,0.18);
      border-color: var(--accent);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOAST
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(80px);
      background: var(--surface2);
      border: 1px solid var(--border);
      border-left: 3px solid var(--accent);
      padding: 10px 18px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 11px;
      letter-spacing: 1px;
      z-index: 9999;
      transition: transform 0.3s ease;
    }

    #toast.show { transform: translateX(-50%) translateY(0); }

    /* Marker ring-pulse */
    @keyframes ring-pulse {
      0% { transform: scale(1); opacity: 0.8; }
      100% { transform: scale(3); opacity: 0; }
    }
  </style>
</head>
<body>

<!-- â•â• LOADING OVERLAY (from index1) â•â• -->
<div id="loading-overlay">
  <div class="loading-logo">DISASTER<span style="color:var(--accent)">WATCH</span></div>
  <div class="loading-bar-wrap"><div class="loading-bar"></div></div>
  <div class="loading-text">Connecting to live feeds...</div>
</div>

<!-- â•â• HEADER â•â• -->
<div id="header">
  <div class="logo">
    <div class="logo-icon"></div>
    <h1>Disaster<span>Watch</span></h1>
  </div>
  <div class="header-status">
    <div class="live-badge">
      <div class="live-dot"></div>
      Live
    </div>
    <div class="incident-count">
      <strong id="total-count">0</strong> incidents
    </div>
    <div class="last-updated" id="last-updated-el">â€”</div>
    <button class="btn" onclick="toggleCharts()">â—ˆ Analytics</button>
    <button class="btn btn-danger" id="refresh-btn" onclick="refreshData()">âŸ³ Refresh</button>
  </div>
</div>

<!-- â•â• SIDEBAR (Active Incidents â€” index1 style) â•â• -->
<div id="sidebar">
  <div class="sidebar-toggle" id="sidebar-toggle" onclick="toggleSidebar()">â—€</div>

  <div class="sidebar-header">
    <h2>Active Incidents</h2>
  </div>

  <div class="filters" id="filters"></div>

  <div id="incident-list"></div>

  <!-- Stats Bar at bottom (index1 style) -->
  <div class="stats-bar">
    <div class="stat">
      <div class="stat-num" id="stat-critical" style="color:var(--accent)">0</div>
      <div class="stat-label">Critical</div>
    </div>
    <div class="stat">
      <div class="stat-num" id="stat-moderate" style="color:var(--accent2)">0</div>
      <div class="stat-label">High+</div>
    </div>
    <div class="stat">
      <div class="stat-num" id="stat-sources" style="color:var(--blue)">0</div>
      <div class="stat-label">Sources</div>
    </div>
  </div>
</div>

<!-- â•â• MAP â•â• -->
<div id="map"></div>

<!-- â•â• CHARTS PANEL â•â• -->
<div id="charts-panel">
  <div class="charts-header">
    <h2>â—ˆ Disaster Analytics</h2>
    <button class="btn" onclick="toggleCharts()">âœ• Close</button>
  </div>

  <div class="chart-container">
    <div class="chart-title">Incidents by Type</div>
    <canvas id="typeChart"></canvas>
  </div>

  <div class="chart-container">
    <div class="chart-title">Severity Distribution</div>
    <canvas id="severityChart"></canvas>
  </div>

  <div class="chart-container">
    <div class="chart-title">Incidents Over Time (24h)</div>
    <canvas id="timelineChart"></canvas>
  </div>

  <div class="chart-container">
    <div class="chart-title">Top 10 Affected Regions</div>
    <canvas id="regionChart"></canvas>
  </div>
</div>

<!-- â•â• LEGEND â•â• -->
<div id="legend">
  <div class="legend-title">Severity</div>
  <div class="legend-row">
    <div class="legend-circle" style="width:18px;height:18px;background:rgba(255,59,59,0.8);border:2px solid #ff3b3b"></div>
    <div class="legend-label">Critical / M7+</div>
  </div>
  <div class="legend-row">
    <div class="legend-circle" style="width:14px;height:14px;background:rgba(255,140,0,0.8);border:2px solid #ff8c00"></div>
    <div class="legend-label">High / M6+</div>
  </div>
  <div class="legend-row">
    <div class="legend-circle" style="width:10px;height:10px;background:rgba(255,215,0,0.8);border:2px solid #ffd700"></div>
    <div class="legend-label">Moderate / M5+</div>
  </div>
  <div class="legend-row">
    <div class="legend-circle" style="width:8px;height:8px;background:rgba(57,211,83,0.8);border:2px solid #39d353"></div>
    <div class="legend-label">Low</div>
  </div>
</div>

<!-- â•â• TOAST â•â• -->
<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DISASTERWATCH â€” Enhanced (index.html + index1 UI)
//  Data: USGS Â· NASA EONET Â· GDACS Â· ReliefWeb
//  UI:   Index1 Active Incidents Box + Loading Anim
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const DISASTER_TYPES = {
  earthquake:  { color: '#ff4444', icon: 'ğŸŒ', label: 'Earthquake' },
  flood:       { color: '#4488ff', icon: 'ğŸ’§', label: 'Flood' },
  fire:        { color: '#ff8800', icon: 'ğŸ”¥', label: 'Wildfire' },
  storm:       { color: '#aa44ff', icon: 'ğŸŒ€', label: 'Storm' },
  volcano:     { color: '#ff4400', icon: 'ğŸŒ‹', label: 'Volcano' },
  tsunami:     { color: '#0099ff', icon: 'ğŸŒŠ', label: 'Tsunami' },
  drought:     { color: '#f39c12', icon: 'ğŸœï¸', label: 'Drought' },
  landslide:   { color: '#795548', icon: 'â›°ï¸', label: 'Landslide' },
  heatwave:    { color: '#ff5722', icon: 'ğŸŒ¡ï¸', label: 'Heatwave' },
  coldwave:    { color: '#00bcd4', icon: 'â„ï¸', label: 'Cold Wave' },
  tornado:     { color: '#7d3c98', icon: 'ğŸŒªï¸', label: 'Tornado' },
  avalanche:   { color: '#b0bec5', icon: 'ğŸ”ï¸', label: 'Avalanche' },
  cyclone:     { color: '#673ab7', icon: 'ğŸŒ€', label: 'Cyclone' },
  dust:        { color: '#a1887f', icon: 'ğŸ’¨', label: 'Dust Storm' },
  other:       { color: '#aaaaaa', icon: 'âš ï¸', label: 'Incident' },
};

// â”€â”€ Enhanced NLP Keywords â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const NLP_KEYWORDS = {
  earthquake: {
    primary: ['earthquake', 'quake', 'seismic', 'tremor', 'aftershock', 'temblor'],
    context: ['magnitude', 'richter', 'epicenter', 'fault', 'tectonic'],
    severity: ['massive', 'devastating', 'powerful', 'major', 'strong']
  },
  flood: {
    primary: ['flood', 'flooding', 'flooded', 'deluge', 'inundation'],
    context: ['river', 'dam', 'rainfall', 'monsoon', 'overflow', 'submerged'],
    severity: ['catastrophic', 'severe', 'extreme', 'widespread']
  },
  fire: {
    primary: ['wildfire', 'fire', 'blaze', 'inferno', 'bushfire', 'forest fire'],
    context: ['burning', 'acres', 'hectares', 'smoke', 'evacuate'],
    severity: ['out of control', 'raging', 'uncontained', 'massive']
  },
  storm: {
    primary: ['storm', 'hurricane', 'typhoon', 'tempest'],
    context: ['winds', 'mph', 'landfall', 'category', 'pressure', 'gusts'],
    severity: ['category 5', 'category 4', 'super', 'intense']
  },
  volcano: {
    primary: ['volcano', 'volcanic', 'eruption', 'erupt'],
    context: ['lava', 'ash', 'pyroclastic', 'magma', 'crater'],
    severity: ['major eruption', 'explosive']
  },
  tsunami: {
    primary: ['tsunami', 'tidal wave'],
    context: ['wave', 'coastal', 'sea', 'ocean', 'surge'],
    severity: ['major', 'deadly', 'devastating']
  },
  tornado: {
    primary: ['tornado', 'twister', 'funnel cloud'],
    context: ['rotation', 'ef', 'touchdown', 'vortex'],
    severity: ['ef5', 'ef4', 'violent']
  },
  cyclone: {
    primary: ['cyclone', 'tropical cyclone'],
    context: ['category', 'winds', 'depression', 'circulation'],
    severity: ['severe', 'super', 'very severe']
  },
  drought: {
    primary: ['drought', 'dry spell', 'water shortage'],
    context: ['rainfall', 'precipitation', 'arid', 'parched'],
    severity: ['extreme', 'severe', 'exceptional']
  },
  heatwave: {
    primary: ['heatwave', 'heat wave', 'extreme heat'],
    context: ['temperature', 'degrees', 'celsius', 'fahrenheit'],
    severity: ['record', 'unprecedented', 'deadly']
  },
  coldwave: {
    primary: ['cold wave', 'coldwave', 'freeze', 'arctic blast'],
    context: ['temperature', 'below zero', 'frost', 'ice'],
    severity: ['extreme', 'record', 'historic']
  },
  landslide: {
    primary: ['landslide', 'mudslide', 'rockslide', 'debris flow'],
    context: ['slope', 'hillside', 'buried', 'soil'],
    severity: ['massive', 'deadly', 'catastrophic']
  },
  avalanche: {
    primary: ['avalanche', 'snow slide'],
    context: ['mountain', 'snow', 'alpine', 'slope'],
    severity: ['major', 'deadly']
  },
  dust: {
    primary: ['dust storm', 'sandstorm', 'haboob'],
    context: ['visibility', 'dust', 'sand', 'desert'],
    severity: ['massive', 'severe']
  }
};

function classifyDisaster(text) {
  const lower = text.toLowerCase();
  let bestMatch = { type: null, score: 0 };
  for (const [type, kws] of Object.entries(NLP_KEYWORDS)) {
    let score = 0;
    for (const kw of kws.primary)   if (lower.includes(kw)) score += 10;
    for (const kw of kws.context)   if (lower.includes(kw)) score += 3;
    for (const kw of kws.severity)  if (lower.includes(kw)) score += 2;
    if (score > bestMatch.score) bestMatch = { type, score };
  }
  return bestMatch.score >= 10 ? bestMatch.type : 'other';
}

function extractSeverity(text, magnitude = null) {
  const lower = text.toLowerCase();
  if (magnitude !== null) {
    if (magnitude >= 7.0) return 'critical';
    if (magnitude >= 6.0) return 'high';
    if (magnitude >= 5.0) return 'moderate';
    return 'low';
  }
  const critical = ['catastrophic', 'devastating', 'deadly', 'major disaster', 'emergency', 'red'];
  const high = ['severe', 'major', 'significant', 'widespread', 'intense', 'orange'];
  const moderate = ['moderate', 'notable', 'considerable'];
  if (critical.some(kw => lower.includes(kw))) return 'critical';
  if (high.some(kw => lower.includes(kw))) return 'high';
  if (moderate.some(kw => lower.includes(kw))) return 'moderate';
  return 'low';
}

const SEVERITY_CONFIG = {
  critical: { radius: 16, color: '#ff3b3b', glow: 'rgba(255,59,59,0.4)',  pulse: true },
  high:     { radius: 12, color: '#ff8c00', glow: 'rgba(255,140,0,0.3)',  pulse: false },
  moderate: { radius: 9,  color: '#ffd700', glow: 'rgba(255,215,0,0.25)', pulse: false },
  low:      { radius: 7,  color: '#39d353', glow: 'rgba(57,211,83,0.2)',  pulse: false },
};

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allIncidents = [];
let markers = {};
let activeFilters = new Set(Object.keys(DISASTER_TYPES));
let activeItemId = null;
let sidebarOpen = true;
let chartsOpen = false;
let map;

let charts = { type: null, severity: null, timeline: null, region: null };

// â”€â”€ Add CSS keyframes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function() {
  const s = document.createElement('style');
  s.textContent = `
    @keyframes pulse-ring {
      0%   { transform: translate(-50%,-50%) scale(1); opacity: 0.7; }
      100% { transform: translate(-50%,-50%) scale(3.2); opacity: 0; }
    }
  `;
  document.head.appendChild(s);
})();

// â”€â”€ Init Map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initMap() {
  map = L.map('map', {
    center: [20, 0],
    zoom: 2.5,
    zoomControl: true,
    attributionControl: false,
  });

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
  }).addTo(map);

  L.control.attribution({ prefix: false })
    .addAttribution('DisasterWatch | OpenStreetMap | USGS | NASA | GDACS | ReliefWeb')
    .addTo(map);
}

// â”€â”€ Create Marker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function createMarker(incident) {
  const type = DISASTER_TYPES[incident.type] || DISASTER_TYPES.other;
  const sev  = SEVERITY_CONFIG[incident.severity] || SEVERITY_CONFIG.low;
  const size = sev.radius * 2;

  const pulseHtml = sev.pulse ? `
    <div style="
      position:absolute; top:50%; left:50%;
      width:${size}px; height:${size}px;
      border-radius:50%;
      background:${sev.color};
      opacity:0.4;
      animation: pulse-ring 2s ease-out infinite;
    "></div>` : '';

  const iconHtml = `
    <div style="position:relative; width:${size+8}px; height:${size+8}px;">
      ${pulseHtml}
      <div style="
        position:absolute; top:50%; left:50%;
        transform:translate(-50%,-50%);
        width:${size}px; height:${size}px;
        border-radius:50%;
        background:${type.color};
        opacity:0.88;
        border:2px solid rgba(255,255,255,0.2);
        box-shadow:0 0 14px ${sev.glow}, 0 0 4px rgba(0,0,0,0.8);
      "></div>
    </div>`;

  const icon = L.divIcon({
    html: iconHtml,
    className: '',
    iconSize: [size+8, size+8],
    iconAnchor: [(size+8)/2, (size+8)/2],
  });

  const marker = L.marker([incident.lat, incident.lng], { icon })
    .addTo(map)
    .bindPopup(() => buildPopupHTML(incident), { maxWidth: 330, className: 'custom-popup' });

  marker.on('click', () => highlightItem(incident.id));
  return marker;
}

// â”€â”€ Build Popup HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildPopupHTML(incident) {
  const type = DISASTER_TYPES[incident.type] || DISASTER_TYPES.other;
  const sev  = SEVERITY_CONFIG[incident.severity] || SEVERITY_CONFIG.low;
  const timeStr = incident.time
    ? new Date(incident.time).toLocaleString('en-US', {
        month:'short', day:'numeric', hour:'2-digit', minute:'2-digit', timeZoneName:'short'
      })
    : 'Unknown';

  return `
  <div class="popup-inner">
    <div class="popup-header">
      <div class="popup-icon">${type.icon}</div>
      <div>
        <div class="popup-type" style="color:${type.color}">${type.label}</div>
        <div class="popup-title">${incident.title}</div>
      </div>
    </div>
    <div class="popup-divider"></div>
    <div class="popup-row">
      <div class="popup-label">Location</div>
      <div class="popup-value">${incident.location}</div>
    </div>
    <div class="popup-row">
      <div class="popup-label">Severity</div>
      <div class="popup-value" style="color:${sev.color};font-family:'Share Tech Mono',monospace;text-transform:uppercase;letter-spacing:1px;font-size:11px">
        ${incident.severity.toUpperCase()}${incident.magnitude ? ' Â· M' + incident.magnitude : ''}
      </div>
    </div>
    <div class="popup-row">
      <div class="popup-label">Source</div>
      <div class="popup-value" style="color:var(--muted);font-size:11px">${incident.source}</div>
    </div>
    <div class="popup-row">
      <div class="popup-label">Time</div>
      <div class="popup-value" style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--muted)">${timeStr}</div>
    </div>
    ${incident.description ? `
    <div class="popup-row">
      <div class="popup-label">Details</div>
      <div class="popup-value" style="font-size:12px;color:var(--muted)">${incident.description}</div>
    </div>` : ''}
    <a class="popup-link" href="${incident.url}" target="_blank" rel="noopener">â†— View Source Report</a>
  </div>`;
}

// â”€â”€ Build Filters (dynamic â€” all types) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildFilters() {
  const container = document.getElementById('filters');
  container.innerHTML = '';

  // All button
  const allBtn = document.createElement('button');
  allBtn.className = 'filter-btn active';
  allBtn.innerHTML = `<span class="filter-dot" style="background:#fff"></span> All`;
  allBtn.onclick = () => toggleAllFilters(allBtn);
  container.appendChild(allBtn);

  for (const [type, cfg] of Object.entries(DISASTER_TYPES)) {
    const btn = document.createElement('button');
    btn.className = 'filter-btn active';
    btn.dataset.type = type;
    btn.style.setProperty('--type-color', cfg.color);
    btn.innerHTML = `<span class="filter-dot" style="background:${cfg.color}"></span> ${cfg.label}`;
    btn.onclick = () => toggleFilter(type, btn);
    container.appendChild(btn);
  }
}

function toggleAllFilters(btn) {
  if (activeFilters.size === Object.keys(DISASTER_TYPES).length) {
    activeFilters.clear();
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  } else {
    activeFilters = new Set(Object.keys(DISASTER_TYPES));
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.add('active'));
  }
  updateVisibility();
}

function toggleFilter(type, btn) {
  if (activeFilters.has(type)) {
    activeFilters.delete(type);
    btn.classList.remove('active');
  } else {
    activeFilters.add(type);
    btn.classList.add('active');
  }
  updateVisibility();
}

function updateVisibility() {
  allIncidents.forEach(inc => {
    const show = activeFilters.has(inc.type);
    if (markers[inc.id]) {
      if (show) markers[inc.id].addTo(map);
      else markers[inc.id].remove();
    }
  });
  buildList();
}

// â”€â”€ Build Incident List (index1 item style) â”€â”€â”€â”€â”€â”€â”€â”€
function buildList() {
  const list = document.getElementById('incident-list');
  list.innerHTML = '';

  const visible = allIncidents.filter(i => activeFilters.has(i.type));

  if (visible.length === 0) {
    list.innerHTML = `<div style="padding:24px;text-align:center;color:var(--muted);font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:2px">NO INCIDENTS MATCH FILTERS</div>`;
    return;
  }

  visible.forEach(inc => {
    const type = DISASTER_TYPES[inc.type] || DISASTER_TYPES.other;
    const sev  = SEVERITY_CONFIG[inc.severity] || SEVERITY_CONFIG.low;
    const sevColors = { critical: '#ff3b3b', high: '#ff8c00', moderate: '#ffd700', low: '#39d353' };
    const sevColor = sevColors[inc.severity] || '#aaa';
    const timeAgo = getTimeAgo(inc.time);

    const el = document.createElement('div');
    el.className = 'incident-item' + (inc.id === activeItemId ? ' active' : '');
    el.id = `item-${inc.id}`;

    el.innerHTML = `
      <div class="incident-top">
        <span class="incident-type-badge" style="color:${type.color};background:${type.color}18;border:1px solid ${type.color}40">
          ${type.icon} ${type.label}
        </span>
        <span class="incident-sev-label" style="color:${sevColor}">${inc.severity.toUpperCase()}</span>
      </div>
      <div class="incident-title">${inc.title}</div>
      <div class="incident-loc">ğŸ“ ${inc.location}</div>
      <div class="incident-bottom">
        <span class="incident-source" style="color:${type.color};background:${type.color}12;border:1px solid ${type.color}30">${inc.source || 'Unknown'}</span>
        <span class="incident-time">${timeAgo}</span>
      </div>
    `;

    el.onclick = () => focusIncident(inc.id);
    list.appendChild(el);
  });

  updateStats();
}

// â”€â”€ Focus Incident â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function focusIncident(id) {
  const inc = allIncidents.find(i => i.id === id);
  if (!inc) return;
  activeItemId = id;
  buildList();
  const el = document.getElementById(`item-${id}`);
  if (el) el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  map.setView([inc.lat, inc.lng], Math.max(map.getZoom(), 6), { animate: true });
  if (markers[id]) markers[id].openPopup();
}

function highlightItem(id) {
  activeItemId = id;
  buildList();
  const el = document.getElementById(`item-${id}`);
  if (el) el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateStats() {
  const critical = allIncidents.filter(i => i.severity === 'critical').length;
  const highPlus  = allIncidents.filter(i => ['high','critical'].includes(i.severity)).length;
  const sources   = new Set(allIncidents.map(i => i.source)).size;

  document.getElementById('stat-critical').textContent = critical;
  document.getElementById('stat-moderate').textContent = highPlus;
  document.getElementById('stat-sources').textContent  = sources;
  document.getElementById('total-count').textContent   = allIncidents.length;
}

// â”€â”€ UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSidebar() {
  sidebarOpen = !sidebarOpen;
  document.getElementById('sidebar').classList.toggle('collapsed', !sidebarOpen);
  document.getElementById('sidebar-toggle').textContent = sidebarOpen ? 'â—€' : 'â–¶';
}

function toggleCharts() {
  chartsOpen = !chartsOpen;
  document.getElementById('charts-panel').classList.toggle('open', chartsOpen);
  document.getElementById('legend').classList.toggle('shifted', chartsOpen);
  if (chartsOpen) updateCharts();
}

// â”€â”€ Time Helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getTimeAgo(isoTime) {
  if (!isoTime) return 'â€”';
  const diff = Date.now() - new Date(isoTime).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1)  return 'Just now';
  if (mins < 60) return `${mins}m ago`;
  const hrs = Math.floor(mins / 60);
  if (hrs < 24)  return `${hrs}h ago`;
  return `${Math.floor(hrs / 24)}d ago`;
}

// â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg, duration = 3000) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), duration);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHARTS & ANALYTICS (from index.html)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateCharts() {
  updateTypeChart();
  updateSeverityChart();
  updateTimelineChart();
  updateRegionChart();
}

function updateTypeChart() {
  const typeCounts = {};
  for (const t of Object.keys(DISASTER_TYPES)) typeCounts[t] = allIncidents.filter(i => i.type === t).length;
  const data = {
    labels: Object.keys(typeCounts).map(t => DISASTER_TYPES[t].label),
    datasets: [{
      data: Object.values(typeCounts),
      backgroundColor: Object.keys(typeCounts).map(t => DISASTER_TYPES[t].color + '80'),
      borderColor: Object.keys(typeCounts).map(t => DISASTER_TYPES[t].color),
      borderWidth: 2,
    }]
  };
  if (charts.type) charts.type.destroy();
  charts.type = new Chart(document.getElementById('typeChart'), {
    type: 'doughnut', data,
    options: { responsive: true, plugins: { legend: { labels: { color: '#7d8590', font: { size: 10 } } } } }
  });
}

function updateSeverityChart() {
  const severities = ['critical', 'high', 'moderate', 'low'];
  const colors = ['#ff3b3b', '#ff8c00', '#ffd700', '#39d353'];
  const data = {
    labels: severities.map(s => s.toUpperCase()),
    datasets: [{ label: 'Count', data: severities.map(s => allIncidents.filter(i => i.severity === s).length),
      backgroundColor: colors.map(c => c + '80'), borderColor: colors, borderWidth: 2 }]
  };
  if (charts.severity) charts.severity.destroy();
  charts.severity = new Chart(document.getElementById('severityChart'), {
    type: 'bar', data,
    options: { responsive: true, plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true, ticks: { color: '#7d8590' }, grid: { color: '#21262d' } },
                x: { ticks: { color: '#7d8590' }, grid: { display: false } } } }
  });
}

function updateTimelineChart() {
  const now = Date.now(), hours = 24;
  const buckets = Array(hours).fill(0);
  allIncidents.forEach(inc => {
    if (!inc.time) return;
    const age = (now - new Date(inc.time).getTime()) / (1000 * 60 * 60);
    if (age >= 0 && age < hours) buckets[Math.floor(age)]++;
  });
  const labels = Array.from({ length: hours }, (_, i) => `${hours - i}h ago`);
  const data = {
    labels: labels.reverse(),
    datasets: [{ label: 'Incidents', data: buckets.reverse(),
      borderColor: '#58a6ff', backgroundColor: '#58a6ff20', fill: true, tension: 0.4 }]
  };
  if (charts.timeline) charts.timeline.destroy();
  charts.timeline = new Chart(document.getElementById('timelineChart'), {
    type: 'line', data,
    options: { responsive: true, plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true, ticks: { color: '#7d8590' }, grid: { color: '#21262d' } },
                x: { ticks: { color: '#7d8590', maxTicksLimit: 10 }, grid: { display: false } } } }
  });
}

function updateRegionChart() {
  const regions = {};
  allIncidents.forEach(inc => {
    const loc = inc.location.split(',').pop().trim();
    regions[loc] = (regions[loc] || 0) + 1;
  });
  const sorted = Object.entries(regions).sort((a, b) => b[1] - a[1]).slice(0, 10);
  const data = {
    labels: sorted.map(r => r[0]),
    datasets: [{ label: 'Incidents', data: sorted.map(r => r[1]),
      backgroundColor: '#9775fa80', borderColor: '#9775fa', borderWidth: 2 }]
  };
  if (charts.region) charts.region.destroy();
  charts.region = new Chart(document.getElementById('regionChart'), {
    type: 'bar', data,
    options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: false } },
      scales: { x: { beginAtZero: true, ticks: { color: '#7d8590' }, grid: { color: '#21262d' } },
                y: { ticks: { color: '#7d8590' }, grid: { display: false } } } }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA SOURCES â€” USGS Â· NASA EONET Â· GDACS Â· ReliefWeb
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function fetchUSGS() {
  const res  = await fetch('https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_day.geojson');
  const data = await res.json();
  return data.features.map(f => {
    const mag = f.properties.mag;
    return {
      id: 'usgs_' + f.id,
      type: 'earthquake',
      title: f.properties.title,
      location: f.properties.place,
      lat: f.geometry.coordinates[1],
      lng: f.geometry.coordinates[0],
      severity: extractSeverity('', mag),
      magnitude: mag.toFixed(1),
      time: new Date(f.properties.time).toISOString(),
      source: 'USGS',
      url: f.properties.url,
      description: `Depth: ${f.geometry.coordinates[2].toFixed(1)} km Â· Felt by ${f.properties.felt || 0} people`,
    };
  }).filter(i => i.lat && i.lng);
}

async function fetchNASAEONET() {
  const res  = await fetch('https://eonet.gsfc.nasa.gov/api/v3/events?status=open&days=14&limit=100');
  const data = await res.json();
  const incidents = [];
  for (const event of data.events) {
    const category = event.categories?.[0]?.title || '';
    const type = classifyDisaster(category);
    const geo  = event.geometry?.[event.geometry.length - 1];
    if (!geo?.coordinates) continue;
    let [lng, lat] = geo.type === 'Point' ? geo.coordinates : geo.coordinates[0];
    incidents.push({
      id: 'nasa_' + event.id,
      type,
      title: event.title,
      location: event.title,
      lat, lng,
      severity: extractSeverity(event.title),
      time: geo.date,
      source: 'NASA EONET',
      url: event.sources?.[0]?.url || 'https://eonet.gsfc.nasa.gov',
      description: `${category} Â· Active natural event`,
    });
  }
  return incidents.filter(i => i.lat && i.lng);
}

async function fetchGDACS() {
  try {
    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent('https://www.gdacs.org/xml/rss.xml')}`;
    const res  = await fetch(proxyUrl, { signal: AbortSignal.timeout(10000) });
    const data = await res.json();
    const xml  = new DOMParser().parseFromString(data.contents, 'text/xml');
    const items = xml.querySelectorAll('item');
    const incidents = [];
    items.forEach((item, idx) => {
      if (idx > 30) return;
      const title   = item.querySelector('title')?.textContent || '';
      const link    = item.querySelector('link')?.textContent  || 'https://gdacs.org';
      const desc    = item.querySelector('description')?.textContent || '';
      const pubDate = item.querySelector('pubDate')?.textContent;
      const lat     = parseFloat(item.querySelector('geo\\:lat, lat')?.textContent);
      const lng     = parseFloat(item.querySelector('geo\\:long, long')?.textContent);
      if (isNaN(lat) || isNaN(lng)) return;
      incidents.push({
        id: 'gdacs_' + idx,
        type: classifyDisaster(title + ' ' + desc),
        title: title.trim(),
        location: title.split('-').pop()?.trim() || 'Unknown',
        lat, lng,
        severity: extractSeverity(title + ' ' + desc),
        time: pubDate ? new Date(pubDate).toISOString() : null,
        source: 'GDACS',
        url: link,
        description: desc.replace(/<[^>]+>/g, '').slice(0, 150),
      });
    });
    return incidents;
  } catch (e) { console.warn('GDACS fetch failed:', e); return []; }
}

async function fetchReliefWeb() {
  const url = 'https://api.reliefweb.int/v1/disasters?appname=disasterwatch&fields[include][]=name&fields[include][]=country&fields[include][]=date&fields[include][]=type&fields[include][]=url&filter[field]=status&filter[value]=current&limit=50';
  const res  = await fetch(url);
  const data = await res.json();

  const COORDS = {
    'Afghanistan':[33.9,67.7],'Albania':[41.2,19.8],'Algeria':[28.0,1.6],'Angola':[-11.2,17.9],
    'Argentina':[-38.4,-63.6],'Australia':[-25.3,133.8],'Bangladesh':[23.7,90.4],'Bolivia':[-16.3,-63.6],
    'Brazil':[-14.2,-51.9],'Burkina Faso':[12.2,-1.6],'Cameroon':[7.4,12.4],'Canada':[56.1,-106.3],
    'Central African Republic':[6.6,20.9],'Chad':[15.5,18.7],'Chile':[-35.7,-71.5],'China':[35.9,104.2],
    'Colombia':[4.6,-74.1],'Democratic Republic of the Congo':[-4.0,21.8],'Ecuador':[-1.8,-78.2],
    'Egypt':[26.8,30.8],'Ethiopia':[9.1,40.5],'Haiti':[18.9,-72.3],'Honduras':[15.2,-86.2],
    'India':[20.6,78.9],'Indonesia':[-0.8,113.9],'Iran':[32.4,53.7],'Iraq':[33.2,43.7],
    'Kenya':[0.02,37.9],'Madagascar':[-18.8,46.9],'Mali':[17.6,-4.0],'Mexico':[23.6,-102.5],
    'Mozambique':[-18.7,35.5],'Myanmar':[21.9,95.9],'Nepal':[28.4,84.1],'Niger':[17.6,8.1],
    'Nigeria':[9.1,8.7],'Pakistan':[30.4,69.3],'Peru':[-9.2,-75.0],'Philippines':[12.9,122.0],
    'Somalia':[5.2,46.2],'South Sudan':[7.0,30.0],'Sudan':[12.9,30.2],'Syria':[34.8,38.9],
    'Turkey':[38.9,35.2],'Uganda':[1.4,32.3],'Ukraine':[48.4,31.2],'Venezuela':[6.4,-66.6],
    'Yemen':[15.6,48.5],'Zimbabwe':[-19.0,29.2],
  };

  const results = [];
  for (const item of data.data || []) {
    const f = item.fields;
    const country = f.country?.[0]?.name;
    if (!country || !COORDS[country]) continue;
    const [lat, lng] = COORDS[country];
    results.push({
      id: 'rw_' + item.id,
      type: classifyDisaster(f.name),
      title: f.name,
      location: country,
      lat: lat + (Math.random() - 0.5) * 4,
      lng: lng + (Math.random() - 0.5) * 4,
      severity: 'high',
      time: f.date?.created,
      source: 'ReliefWeb',
      url: f.url || `https://reliefweb.int/disaster/${item.id}`,
      description: 'Active humanitarian disaster',
    });
  }
  return results;
}

// â”€â”€ Dedup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function deduplicateIncidents(incidents) {
  const seen = [];
  return incidents.filter(inc => {
    const clash = seen.find(s =>
      s.type === inc.type &&
      Math.abs(s.lat - inc.lat) < 0.5 &&
      Math.abs(s.lng - inc.lng) < 0.5
    );
    if (!clash) { seen.push(inc); return true; }
    return false;
  });
}

// â”€â”€ Main Refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function refreshData() {
  const btn = document.getElementById('refresh-btn');
  btn.classList.add('spinning');

  try {
    showToast('âŸ³ Fetching from USGS, NASA, GDACS, ReliefWeb...');

    const results = await Promise.allSettled([
      fetchUSGS(),
      fetchNASAEONET(),
      fetchGDACS(),
      fetchReliefWeb(),
    ]);

    const combined = results
      .filter(r => r.status === 'fulfilled')
      .flatMap(r => r.value);

    const deduped = deduplicateIncidents(combined);
    const sevOrder = { critical: 0, high: 1, moderate: 2, low: 3 };
    deduped.sort((a, b) => {
      const sd = (sevOrder[a.severity] || 3) - (sevOrder[b.severity] || 3);
      if (sd !== 0) return sd;
      return new Date(b.time || 0) - new Date(a.time || 0);
    });

    Object.values(markers).forEach(m => m.remove());
    markers = {};
    allIncidents = deduped;

    deduped.forEach(inc => { markers[inc.id] = createMarker(inc); });

    buildList();
    if (chartsOpen) updateCharts();

    const now = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    document.getElementById('last-updated-el').textContent = `Updated ${now}`;

    const successCount = results.filter(r => r.status === 'fulfilled').length;
    showToast(`âœ“ ${deduped.length} incidents from ${successCount} sources`);

  } catch (err) {
    console.error('Refresh error:', err);
    showToast('âš  Error fetching data');
  } finally {
    btn.classList.remove('spinning');
  }
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded', async () => {
  initMap();
  buildFilters();

  // Hide loading overlay after animation completes
  setTimeout(() => {
    document.getElementById('loading-overlay').classList.add('hidden');
  }, 2000);

  await refreshData();

  // Auto-refresh every 5 minutes
  setInterval(refreshData, 5 * 60 * 1000);
});
</script>
</body>
</html>
